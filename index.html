<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Catch Game</title>
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #ff0050, #00f2ea, #000000);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; 
        }

        #phone-container {
            width: 400px;
            height: 100vh;
            max-width: 100%;
            max-height: 100vh;
            position: relative;
            background: #000000; 
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            border-radius: 0;
            overflow: hidden; /* –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—ñ, —â–æ–± –≤–æ–Ω–∏ –Ω–µ –≤–∏—Ö–æ–¥–∏–ª–∏ –∑–∞ –º–µ–∂—ñ */
            display: flex;
            flex-direction: column;
            border: 0;
        }

        #game-area {
            position: relative;
            flex-grow: 1;
            background: url('https://i.postimg.cc/Pf661Sdy/Pngtree-tiktok-frame-for-streaming-8732477.png') center/cover no-repeat;
            background-color: rgba(0, 0, 0, 0.0); 
            overflow: hidden;
            --frame-top: 10%; 
            --frame-bottom: 10%;
            --frame-left: 5%;
            --frame-right: 5%;
        }

        #chest {
            position: absolute;
            width: 80px; 
            height: auto; 
            max-height: 80px; 
            cursor: grab;
            transition: transform 0.1s linear;
            z-index: 5;
            object-fit: contain; 
        }
        #chest:active {
            cursor: grabbing;
        }

        .gift, .coin-flying {
            position: absolute;
            width: 45px;
            height: 45px;
            z-index: 3;
            object-fit: contain; 
        }
        
        .collected-coin-img {
            width: 30px; 
            height: 30px;
            object-fit: contain;
        }

        .coin-flying {
            animation: fly-to-target 1s ease-out forwards;
        }

        @keyframes fly-to-target {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            50% {
                opacity: 1;
                transform: translate(calc((var(--target-x) - var(--start-x)) / 2), -50px) scale(1.2); 
            }
            100% {
                transform: translate(calc(var(--target-x) - var(--start-x)), calc(var(--target-y) - var(--start-y))) scale(0.5);
                opacity: 0;
            }
        }
        
        #modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30;
        }

        #modal-content {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 30px #ff0050;
            max-width: 80%;
            transform: scale(0.8);
            animation: modal-in 0.3s forwards;
            position: relative; 
            overflow: hidden; 
        }
        
        @keyframes modal-in {
            to { transform: scale(1); }
        }

        /* Confetti animation styles */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #ff0050; 
            border-radius: 50%;
            opacity: 0;
            z-index: 31; /* –ü–Ü–î–í–ò–©–ï–ù–û Z-INDEX */
            /* Improved fall animation */
            animation-name: fall;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
        .confetti.coin {
            width: 25px;
            height: 25px;
            background: none;
            border-radius: 0;
            animation-name: fall-coin;
        }
        .confetti.coin img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Confetti Keyframes: now uses variables for random movement */
        @keyframes fall {
            0% { transform: translate(var(--start-x, 0px), -100px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translate(var(--end-x, 0px), var(--end-y, 100%)) rotate(var(--rot, 720deg)); opacity: 0; }
        }

        @keyframes fall-coin {
            0% { transform: translate(var(--start-x, 0px), -100px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translate(var(--end-x, 0px), var(--end-y, 100%)) rotate(var(--rot, 720deg)); opacity: 0; }
        }

    </style>
</head>
<body class="bg-gray-900">

    <div id="phone-container" class="shadow-2xl">
        
        <!-- GET NOW MODAL WINDOW --><div id="modal-overlay" style="display: none;"> 
            <div id="modal-content" class="text-white">
                <div class="text-5xl mb-4">ü•≥</div>
                <h2 class="text-xl font-bold mb-6">You collected all gifts!</h2>
                <button id="get-now-button-modal" class="w-full py-4 text-white font-black text-xl rounded-full shadow-2xl transition active:scale-95 mb-4" style="background-color: #ff0050;">
                    GET NOW
                </button>
                <button id="play-again-button" class="w-full py-2 bg-gray-600/50 text-white font-bold rounded-full transition active:scale-95">
                    PLAY AGAIN
                </button>
            </div>
        </div>

        <!-- Top Bar: Username & Visual Coin Counter --><div id="top-bar" class="p-3 flex justify-between items-start bg-black/50 backdrop-blur-sm z-20">
            <div id="username-target" class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-pink-500 flex items-center justify-center text-white text-xs font-bold">@</div>
                <span class="text-white font-bold text-lg">Evelive25</span>
            </div>
            
            <!-- Visual Coin Display (Increased size and FIXED row layout) --><div id="coin-display" class="flex flex-col items-end space-y-1">
                <div id="collected-coins-container" class="flex flex-row justify-start gap-1 p-2 bg-pink-600/70 rounded-lg shadow-lg h-[40px] w-[240px]">
                    <!-- Coins will appear here --></div>
            </div>
        </div>

        <!-- Game Area --><div id="game-area">
            <!-- Chest --><img id="chest" src="https://i.postimg.cc/ZqhjJgL3/tiktokchest.webp" alt="Treasure Chest"/>
            
            <!-- Confetti/Coins will be appended here --></div>

        
    </div>

    <script>
        const TARGET_SCORE = 7;
        const giftUrls = [
            'https://i.postimg.cc/YqL26Rr2/1.webp',
            'https://i.postimg.cc/QxKNQm88/2.webp',
            'https://i.postimg.cc/jdnqHcxd/3.webp',
            'https://i.postimg.cc/P5GX2Dxg/4.webp',
            'https://i.postimg.cc/FHtrDSz5/5.webp',
            'https://i.postimg.cc/BnWSMFbW/6.webp',
            'https://i.postimg.cc/rw6VQ4s2/7.webp'
        ];
        const coinUrl = 'https://i.postimg.cc/ZqC3txGH/pngwing-com.png';

        const phoneContainer = document.getElementById('phone-container'); // NEW REFERENCE
        const gameArea = document.getElementById('game-area');
        const chest = document.getElementById('chest');
        const collectedCoinsContainer = document.getElementById('collected-coins-container');
        const modalOverlay = document.getElementById('modal-overlay');
        const getNowButtonModal = document.getElementById('get-now-button-modal');
        const playAgainButton = document.getElementById('play-again-button'); 

        chest.src = 'https://i.postimg.cc/ZqhjJgL3/tiktokchest.webp';
        
        const style = getComputedStyle(gameArea);
        const FRAME_TOP_RATIO = parseFloat(style.getPropertyValue('--frame-top')) / 100;
        const FRAME_BOTTOM_RATIO = 1 - parseFloat(style.getPropertyValue('--frame-bottom')) / 100;
        const FRAME_LEFT_RATIO = parseFloat(style.getPropertyValue('--frame-left')) / 100;
        const FRAME_RIGHT_RATIO = 1 - parseFloat(style.getPropertyValue('--frame-right')) / 100;

        let score = 0;
        let gifts = [];
        let gameLoopId;

        let chestWidth = 80;
        let chestHeight = 80; 
        let giftSize = 45;
        let gameAreaRect;
        let phoneContainerRect; // NEW RECT

        let isDragging = false;
        let internalTopBoundary, internalBottomBoundary, internalLeftBoundary, internalRightBoundary;
        let isGameOver = false; 

        function updateGameAreaRect() {
            gameAreaRect = gameArea.getBoundingClientRect();
            phoneContainerRect = phoneContainer.getBoundingClientRect(); // Get phone container bounds
            
            internalTopBoundary = gameAreaRect.height * FRAME_TOP_RATIO;
            internalBottomBoundary = gameAreaRect.height * FRAME_BOTTOM_RATIO - chestHeight; 
            internalLeftBoundary = gameAreaRect.width * FRAME_LEFT_RATIO;
            internalRightBoundary = gameAreaRect.width * FRAME_RIGHT_RATIO - chestWidth; 
        }

        // --- Dragging Logic (Omitted for brevity, unchanged) ---
        function startDrag(e) {
            if (isGameOver) return; 
            e.preventDefault();
            isDragging = true;
            chest.style.cursor = 'grabbing';
        }

        function onDrag(e) {
            if (!isDragging || isGameOver) return; 
            e.preventDefault();

            let clientX = e.clientX || (e.touches && e.touches[0].clientX);
            let clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            if (!clientX || !clientY) return;

            let newX = clientX - gameAreaRect.left - chestWidth / 2;
            let newY = clientY - gameAreaRect.top - chestHeight / 2;
            
            // Clamp X position
            if (newX < internalLeftBoundary) {
                newX = internalLeftBoundary;
            } else if (newX > internalRightBoundary) {
                newX = internalRightBoundary;
            }

            // Clamp Y position
            if (newY < internalTopBoundary) {
                newY = internalTopBoundary;
            } else if (newY > internalBottomBoundary) {
                newY = internalBottomBoundary;
            }

            chest.style.left = `${newX}px`;
            chest.style.top = `${newY}px`;
        }

        function endDrag() {
            isDragging = false;
            chest.style.cursor = 'grab';
        }
        
        chest.addEventListener('pointerdown', startDrag);
        document.addEventListener('pointermove', onDrag);
        document.addEventListener('pointerup', endDrag);
        // ----------------------------------------------------

        function checkCollision(giftRect, chestRect) {
            const padding = 10;
            return giftRect.left + padding < chestRect.right - padding &&
                   giftRect.right - padding > chestRect.left + padding &&
                   giftRect.top + padding < chestRect.bottom - padding &&
                   giftRect.bottom - padding > chestRect.top + padding;
        }

        function addCoinToDisplay() {
            const coin = document.createElement('img');
            coin.src = coinUrl;
            coin.alt = 'Coin';
            coin.className = 'collected-coin-img';
            collectedCoinsContainer.appendChild(coin);
        }
        
        function handleCollection(giftElement, index) {
            if (score >= TARGET_SCORE || isGameOver) return;

            const giftRect = giftElement.getBoundingClientRect();
            const collectedCoinsRect = collectedCoinsContainer.getBoundingClientRect();
            const topBarRect = document.getElementById('top-bar').getBoundingClientRect();

            giftElement.src = coinUrl;
            giftElement.classList.remove('gift');
            giftElement.classList.add('coin-flying');
            
            const startX = giftRect.left - gameAreaRect.left;
            const startY = giftRect.top - gameAreaRect.top;

            const targetX = collectedCoinsRect.left - gameAreaRect.left + (collectedCoinsRect.width / 2); 
            const targetY = topBarRect.top - gameAreaRect.top + (collectedCoinsRect.height / 2); 
            
            giftElement.style.setProperty('--start-x', `${startX}px`);
            giftElement.style.setProperty('--start-y', `${startY}px`);
            giftElement.style.setProperty('--target-x', `${targetX}px`);
            giftElement.style.setProperty('--target-y', `${targetY}px`);

            score++;

            setTimeout(() => {
                giftElement.remove();
                gifts = gifts.filter(g => g !== giftElement); 
                
                addCoinToDisplay(); 
                
                if (score >= TARGET_SCORE) {
                    isGameOver = true; // Set game over flag
                    modalOverlay.style.display = 'flex';
                }

            }, 1000); 
            
            gifts.splice(index, 1);
        }

        function createGift() {
            if (score >= TARGET_SCORE || isGameOver) return;
            // ... (Gift creation logic remains the same)
            const giftElement = document.createElement('img');
            
            const randomIndex = Math.floor(Math.random() * giftUrls.length);
            giftElement.src = giftUrls[randomIndex];
            giftElement.alt = 'Gift';
            giftElement.className = 'gift rounded-full shadow-md';
            
            const direction = Math.random() > 0.5 ? 1 : -1;
            
            const minHeight = internalTopBoundary;
            const maxHeight = internalBottomBoundary + chestHeight - giftSize; 
            const startY = Math.random() * (maxHeight - minHeight) + minHeight; 
            
            const speed = Math.random() * 1.0 + 0.8; 
            
            const startX = direction === 1 
                ? internalLeftBoundary - giftSize 
                : internalRightBoundary + giftSize; 
            
            giftElement.style.top = `${startY}px`;
            giftElement.style.left = `${startX}px`;
            giftElement.dataset.direction = direction;
            giftElement.dataset.speed = speed;
            giftElement.dataset.collected = 'false';

            gameArea.appendChild(giftElement);
            gifts.push(giftElement);
        }

        let giftGenerationTimer = 0;
        const generationInterval = 120; // Generate a new gift every 2 seconds (at 60 FPS)

        function gameLoop(timestamp) {
            updateGameAreaRect();
            
            const chestRect = chest.getBoundingClientRect();

            for (let i = gifts.length - 1; i >= 0; i--) {
                const gift = gifts[i];
                if (gift.dataset.collected === 'true') continue;

                const direction = parseInt(gift.dataset.direction);
                const speed = parseFloat(gift.dataset.speed);
                let currentX = parseFloat(gift.style.left.replace('px', ''));
                
                currentX += direction * speed;
                gift.style.left = `${currentX}px`;

                const giftRect = gift.getBoundingClientRect();
                
                if (!isGameOver && checkCollision(giftRect, chestRect) && gift.dataset.collected === 'false' && score < TARGET_SCORE) {
                    gift.dataset.collected = 'true';
                    handleCollection(gift, i);
                } 
                else if (currentX < internalLeftBoundary - giftSize || currentX > internalRightBoundary + giftSize) {
                    gift.remove();
                    gifts.splice(i, 1);
                }
            }

            if (!isGameOver) {
                giftGenerationTimer++;
                if (giftGenerationTimer >= generationInterval) {
                    createGift();
                    giftGenerationTimer = 0;
                }
            }

            gameLoopId = requestAnimationFrame(gameLoop);
        }
        
        function setInitialChestPosition() {
            const initialX = (gameAreaRect.width / 2) - (chestWidth / 2);
            const initialY = internalBottomBoundary - 10; 
            
            chest.style.left = `${initialX}px`;
            chest.style.top = `${initialY}px`;
        }

        function resetGame() {
            // Hides the modal after the user clicks "PLAY AGAIN"
            modalOverlay.style.display = 'none'; 
            
            // Full game state reset
            isGameOver = false;
            score = 0;
            collectedCoinsContainer.innerHTML = '';
            
            gifts.forEach(gift => gift.remove());
            gifts = [];

            createGift(); 
            setInitialChestPosition(); 
        }

        // ===================================
        // CONFETTI ANIMATION LOGIC (FIXED)
        // ===================================
        const confettiColors = ['#ff0050', '#00f2ea', '#FFD700', '#FFFFFF']; 

        function createConfetti(isCoin = false) {
            const element = document.createElement(isCoin ? 'div' : 'div');
            element.className = 'confetti';
            
            if (isCoin) {
                element.classList.add('coin');
                const img = document.createElement('img');
                img.src = coinUrl;
                element.appendChild(img);
            } else {
                const randomColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                element.style.backgroundColor = randomColor;
            }

            // Start position (Top of the phone container, centered over the modal)
            const phoneRect = phoneContainer.getBoundingClientRect();
            const modalRect = modalOverlay.getBoundingClientRect();
            
            // Start X relative to phone container (Ensures it starts above the modal)
            const startX = (modalRect.left - phoneRect.left) + Math.random() * modalRect.width;
            const startY = modalRect.top - phoneRect.top + 20; 

            // End Y position (Bottom of the phone container)
            const endY = phoneRect.height + 50; 
            
            // Add randomness to horizontal movement (sway) and duration
            const sway = Math.random() * 200 - 100; 
            const duration = Math.random() * 2 + 1.5; 
            
            element.style.setProperty('--start-x', `${startX}px`);
            element.style.setProperty('--end-x', `${startX + sway}px`); 
            element.style.setProperty('--end-y', `${endY}px`); 
            element.style.setProperty('--rot', `${Math.random() * 1080 - 540}deg`); 
            element.style.animationDuration = `${duration}s`;

            element.style.left = `${startX}px`;
            element.style.top = `${startY}px`; 

            phoneContainer.appendChild(element); // Append to phoneContainer 

            // Remove element after animation
            setTimeout(() => {
                element.remove();
            }, duration * 1000); 
        }

        function showConfettiAnimation() {
            // Generate a burst of confetti and coins
            for (let i = 0; i < 70; i++) { 
                setTimeout(() => {
                    createConfetti(Math.random() < 0.3); 
                }, i * 3); 
            }
        }


        window.onload = function() {
            updateGameAreaRect();
            setInitialChestPosition();
            
            createGift(); 
            
            gameLoopId = requestAnimationFrame(gameLoop);
        };
        
        // Handlers for the buttons
        getNowButtonModal.addEventListener('click', () => {
            // 1. Run animation (modal stays open)
            showConfettiAnimation();
            
            // 2. Hide GET NOW button and show PLAY AGAIN
            getNowButtonModal.style.display = 'none';
            playAgainButton.style.display = 'block';

        });

        playAgainButton.addEventListener('click', resetGame);
        playAgainButton.style.display = 'none'; // Initially hidden

        document.addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
            }
        });

    </script>
</body>
</html>
